{% extends "base.html" %}

{% block title %}{{ course.title }}{% endblock %}

{% block content %}
<div class="course-wrapper">
  <!-- Фон -->
  <div class="course-background"></div>

  <!-- Контент поверх фона -->
  <div class="container lesson-section mt-5">
    <!-- Заголовок -->
    <div class="mb-5 fade-title text-center">
      <h1 class="fw-bold display-4">
        <i class="bi bi-journal-bookmark-fill text-primary"></i>
        {{ course.title }}
      </h1>
      {% if course.description %}
      <p class="lead text-muted">{{ course.description }}</p>
      {% endif %}
    </div>

    <!-- Кнопка добавления урока -->
    {% if is_admin %}
    <div class="mb-4 text-center">
      <a href="/admin/courses/{{ course.id }}/lessons/new" class="btn btn-lg btn-primary pulse">
        <i class="bi bi-plus-lg"></i> Добавить урок
      </a>
    </div>
    {% endif %}

    <!-- Список уроков -->
    {% if lessons %}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      {% for l in lessons %}
      <div class="col">
        <div class="card lesson-card h-100 fade-in" style="animation-delay: {{ loop.index0 * 0.1 }}s;">
          <a class="lesson-preview position-relative" href="/lessons/{{ l.id }}">
            {% if l.video_path %}
            <video src="/{{ l.video_path }}" autoplay loop muted playsinline class="lesson-preview-video"></video>
            <div class="play-overlay"><i class="bi bi-play-circle-fill"></i></div>
            {% else %}
            <div class="text-muted small py-5">Видео отсутствует</div>
            {% endif %}
          </a>
          <div class="card-body d-flex flex-column align-items-center text-center">
            <h5 class="card-title mb-2">
              <a href="/lessons/{{ l.id }}" class="lesson-title-link">{{ l.title }}</a>
              {% if l.completed %}
              <i class="bi bi-check-circle-fill text-success ms-2"></i>
              {% endif %}
            </h5>
            {% if l.progress is defined %}
            <div class="progress w-75 mb-3">
              <div class="progress-bar" role="progressbar" style="width: {{ l.progress }}%;" aria-valuenow="{{ l.progress }}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            {% endif %}
            <div class="mt-auto d-flex flex-wrap gap-2 justify-content-center">
              {% if l.video_path %}
              <a href="/{{ l.video_path }}" target="_blank" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-camera-video"></i> Смотреть видео
              </a>
              {% endif %}
              <a href="/lessons/{{ l.id }}" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-book"></i> Перейти к уроку
              </a>
              {% if is_admin %}
              <a href="/admin/lessons/{{ l.id }}/edit" class="btn btn-outline-warning btn-sm">
                <i class="bi bi-pencil"></i> Редактировать
              </a>
              <a href="/admin/lessons/{{ l.id }}/delete" onclick="return confirm('Удалить урок?')" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-trash"></i> Удалить
              </a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="mt-4 text-muted text-center">Уроки ещё не добавлены.</p>
    {% if is_admin %}
    <div class="text-center">
      <a href="/admin/courses/{{ course.id }}/lessons/new" class="btn btn-lg btn-primary pulse">
        <i class="bi bi-plus-lg"></i> Добавить первый урок
      </a>
    </div>
    {% endif %}
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* --- Контейнер --- */
.course-wrapper { position: relative; }

/* --- Фон --- */
.course-background {
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  background: radial-gradient(circle, rgba(255,200,180,0.15) 1px, transparent 1px),
              radial-gradient(circle, rgba(180,220,255,0.15) 1px, transparent 1px),
              radial-gradient(circle, rgba(255,255,180,0.15) 1px, transparent 1px);
  background-size: 30px 30px, 50px 50px, 70px 70px;
  z-index:0;
  pointer-events:none;
  animation: moveStars 60s linear infinite;
}
@keyframes moveStars {
  0% { background-position: 0 0, 0 0, 0 0; }
  50% { background-position: 400px 200px, -300px 150px, 250px -200px; }
  100% { background-position: 0 0, 0 0, 0 0; }
}

/* --- Контент --- */
.lesson-section { position: relative; z-index:1; }

/* Заголовок */
.fade-title { opacity:0; transform:translateY(-30px); animation: fadeSlideDown 1s forwards; }
@keyframes fadeSlideDown { to { opacity:1; transform:translateY(0); } }

/* --- Карточки --- */
.lesson-card {
  position: relative;
  z-index:1;
  border-radius:2rem;
  overflow:hidden;
  background: linear-gradient(145deg,#fffaf2,#fdf2e6);
  box-shadow:0 18px 40px rgba(0,0,0,0.12), inset 0 0 15px rgba(255,255,255,0.2);
  backdrop-filter:blur(12px);
  border:1px solid rgba(163,107,94,0.2);
  opacity:0;
  transform:translateY(20px);
  transition: transform 0.5s ease, box-shadow 0.5s ease, background 0.5s ease;
  animation: fadeInUp 0.9s forwards;
}
.lesson-card:hover {
  transform:translateY(-15px) rotateX(2deg) rotateY(2deg) scale(1.02);
  box-shadow:0 28px 60px rgba(0,0,0,0.18),0 0 15px rgba(255,200,150,0.3);
  background:linear-gradient(145deg,#ffe8d8,#fdded0);
}
@keyframes fadeInUp { to { opacity:1; transform:translateY(0); } }

/* Видео */
.lesson-preview { position: relative; width:100%; overflow:hidden; border-radius:1.2rem; }
.lesson-preview-video { width:100%; max-height:180px; object-fit:cover; border-radius:1.2rem; transition: transform 0.35s ease, box-shadow 0.35s ease, filter 0.35s ease; }
.lesson-preview-video:hover { transform:scale(1.15) rotateZ(0.5deg); box-shadow:0 22px 38px rgba(0,0,0,0.28); filter:brightness(1.08) saturate(1.08); }
.play-overlay { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:3rem; color:rgba(255,255,255,0.8); pointer-events:none; transition: all 0.3s; }
.lesson-preview:hover .play-overlay { color:#ff8f70; transform:translate(-50%,-50%) scale(1.25); }

/* Заголовки и кнопки */
.lesson-card .card-title { font-family:'Poppins',sans-serif; font-weight:700; font-size:1.55rem; display:flex; align-items:center; justify-content:center; gap:0.5rem; }
.lesson-title-link { color:#a36b5e; text-decoration:none; transition: color 0.3s, text-shadow 0.3s; }
.lesson-title-link:hover { color:#7b5a50; text-shadow:0 0 6px rgba(255,150,120,0.6); text-decoration:underline; }

.progress { height:6px; border-radius:3px; background:#e4d5c3; }
.progress-bar { background:#a36b5e; transition: width 0.6s ease; }

.lesson-card .btn { font-size:1rem; padding:0.5rem 1.3rem; border-radius:2rem;
  backdrop-filter: blur(6px); border:1px solid #a36b5e; color:#a36b5e; background: rgba(255,255,255,0.35);
  transition: all 0.35s ease, box-shadow 0.35s ease, transform 0.35s ease; }
.lesson-card .btn:hover { background:linear-gradient(135deg,#a36b5e,#ff8f70); color:#fff;
  box-shadow:0 0 15px 4px rgba(255,140,100,0.55); transform:translateY(-2px) scale(1.05); }
.lesson-card .btn:focus { outline:none; }

/* Пульсация кнопки "Добавить" */
.pulse { animation: pulse 2s infinite; }
@keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(163,107,94,0.5);} 70%{box-shadow:0 0 0 16px rgba(163,107,94,0);} 100%{box-shadow:0 0 0 0 rgba(163,107,94,0);} }

/* Адаптив */
@media(max-width:768px){ .lesson-card .card-title{ font-size:1.35rem; } .lesson-preview-video{ max-height:150px; } }
</style>
{% endblock %}
